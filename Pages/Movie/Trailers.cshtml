@page
@model Movies.Pages.Movie.TrailersModel
@using Movies.Models
@inject Movies.Data.ApplicationDbContext _context

@{
    ViewData["Title"] = "Movie Trailers";
}

<div class="container mt-4">
    <h2 class="mb-4">Movie Trailers</h2>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var movie in Model.Movies)
        {
            <div class="col">
                <div class="card h-100 shadow-sm">
                    @if (!string.IsNullOrEmpty(movie.ImagePath))
                    {
                        <img src="@movie.ImagePath" class="card-img-top" style="height:250px; object-fit:cover;" alt="@movie.Title" />
                    }
                    else
                    {
                        <img src="/images/movies/default.jpg" class="card-img-top" style="height:250px; object-fit:cover;" alt="No Image" />
                    }

                    <div class="card-body text-center">
                        <h6 class="card-title">@movie.Title</h6>

                        @if (!string.IsNullOrEmpty(movie.TrailerUrl))
                        {
                            <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#trailerModal"
                                    data-trailer-url="@movie.TrailerUrl" data-movie-title="@movie.Title">
                                Watch Trailer
                            </button>
                        }
                        else
                        {
                            <span class="text-muted small">No Trailer</span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Trailer Modal -->
<div class="modal fade" id="trailerModal" tabindex="-1" aria-labelledby="trailerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trailerModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="stopTrailer()"></button>
            </div>
            <div class="modal-body">
                <div class="ratio ratio-16x9">
                    <iframe id="trailerIframe" src="" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var trailerModal = document.getElementById('trailerModal');
            var iframe = document.getElementById('trailerIframe');
            var modalTitle = document.getElementById('trailerModalLabel');

            trailerModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var trailerUrl = button.getAttribute('data-trailer-url');
                var movieTitle = button.getAttribute('data-movie-title');

                modalTitle.textContent = movieTitle + " - Trailer";

                // ✅ Normalize and embed YouTube URLs properly
                if (trailerUrl.includes("youtube.com") || trailerUrl.includes("youtu.be")) {
                    if (trailerUrl.includes("watch?v=")) {
                        trailerUrl = trailerUrl.replace("watch?v=", "embed/");
                    } else if (trailerUrl.includes("youtu.be/")) {
                        trailerUrl = trailerUrl.replace("youtu.be/", "www.youtube.com/embed/");
                    }

                    // ✅ Add autoplay, mute (for browser policy), and correct permissions
                    iframe.src = trailerUrl + "?autoplay=1&mute=1";
                    iframe.setAttribute("allow", "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share");
                    iframe.setAttribute("allowfullscreen", true);
                }
                // ✅ Support for local or other trailers (MP4)
                else if (trailerUrl.endsWith(".mp4") || trailerUrl.endsWith(".webm")) {
                    iframe.outerHTML = `
                        <video id="trailerVideo" controls autoplay class="w-100 rounded">
                            <source src="${trailerUrl}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    `;
                }
                // ✅ Fallback: open in a new tab
                else {
                    window.open(trailerUrl, '_blank');
                    var modalInstance = bootstrap.Modal.getInstance(trailerModal);
                    modalInstance.hide();
                }
            });

            // ✅ Stop trailer when modal closes
            trailerModal.addEventListener('hidden.bs.modal', function () {
                stopTrailer();
            });

            function stopTrailer() {
                var iframe = document.getElementById('trailerIframe');
                if (iframe) iframe.src = "";
                var video = document.getElementById('trailerVideo');
                if (video) {
                    video.pause();
                    video.currentTime = 0;
                }
            }
        });
    </script>
}
